name: Build BN Site

on:
  workflow_dispatch:
    inputs:
      doccloud-mode:
        description: "DocumentCloud fetch mode"
        type: choice
        options:
          - incremental
          - backfill
        default: incremental
      publish-db:
        description: "Commit BN data.sqlite to repo"
        type: boolean
        default: true
  schedule:
    - cron: "15 6 * * *"
  push:
    branches:
      - BN-only
    paths-ignore:
      - docs/data.sqlite

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-bn"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      USERNAME: plittle
      PASSWORD: 'pTr8antq$85$c$A'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests documentcloud

      - name: Build BN site (docs output)
        env:
          DC_USERNAME: ${{ env.USERNAME }}
          DC_PASSWORD: ${{ env.PASSWORD }}
          DOCCLOUD_MODE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs['doccloud-mode'] || 'incremental' }}
          DOCCLOUD_INCREMENTAL_DAYS: "10"
          DOCCLOUD_BACKFILL_SINCE: "2021-01-01"
        run: |
          python BN/build_db.py
          BN_DB_URL='./data.sqlite' python BN/build_page.py

      - name: Commit BN database to repo (optional)
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs['publish-db'] == 'true') }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f docs/data.sqlite
          git diff --cached --quiet && echo "No DB changes" || git commit -m "Update BN data.sqlite [skip ci]"
          git push

      - name: Stage BN site
        run: |
          rm -rf public
          mkdir -p public
          mv docs public/BN

      - name: Create root index
        run: |
          cat > public/index.html <<'HTML'
          <!doctype html><meta charset="utf-8">
          <title>BN Site</title>
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <style>
            body { font-family: system-ui, -apple-system, sans-serif; padding: 2rem; }
            h1 { font-size: 1.5rem; }
          </style>
          <h1>Published Site</h1>
          <p><a href="BN/">BN + ATI Match Explorer</a></p>
          HTML

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
