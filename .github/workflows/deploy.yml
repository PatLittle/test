name: Build & Deploy Validation Site

on:
  workflow_dispatch: 

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Free Disk Space Before Build
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r VALIDATION/requirements.txt
          df -h /home/runner/actions-runner/cached/
          

      - name: Fetch CSV & Convert to JSONL
        env:
          AZURE_ACCOUNT_URL: ${{ secrets.AZURE_ACCOUNT_URL }}
          AZURE_CONTAINER:   ${{ secrets.AZURE_CONTAINER }}
          AZURE_SAS_TOKEN:   ${{ secrets.AZURE_SAS_TOKEN }}   # no leading '?'
          AZURE_BLOB_NAME:   ${{ secrets.AZURE_BLOB_NAME }}   # e.g. validation.csv
          OUTPUT_CSV_PATH:   VALIDATION/validation.csv
          OUTPUT_JSONL_PATH: VALIDATION/validation.jsonl
        run: |
          pwd
          ls -larh VALIDATION
          df -h
          python VALIDATION/scripts/fetch_and_convert.py

      - name: Enrich validation JSONL with dataset/resource metadata
        env:
          VALIDATION_JSONL_IN:  VALIDATION/validation.jsonl
          VALIDATION_JSONL_OUT: VALIDATION/validation_enriched.jsonl
          OD_JSONL_GZ_URL: https://open.canada.ca/static/od-do-canada.jsonl.gz
          OD_JSONL_GZ_PATH: od-do-canada.jsonl.gz
        run: python VALIDATION/scripts/enrich_validation.py

      - name: Build static site into /VALIDATION
        env:
          VALIDATION_JSONL: VALIDATION/validation_enriched.jsonl
          SITE_DIR: VALIDATION
        run: |
          pwd
          ls -larh VALIDATION
          python VALIDATION/scripts/build_site.py
          df -h
          sudo rm -rf /tmp/*

      - name: Stage Pages artifact (root contains /VALIDATION)
        run: |
          sudo rm -rf /var/cache/apt/archives/*; rm -rf ~/.cargo
          rm -rf public && mkdir public && mv VALIDATION public/VALIDATION
          cat > public/index.html <<'HTML'
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=VALIDATION/">
          <title>Redirectingâ€¦</title>
          <a href="VALIDATION/">Go to VALIDATION/</a>
          HTML

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
