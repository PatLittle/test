name: Build Validation Site

on:
  workflow_dispatch:
    inputs:
      site-theme:
        description: "Theme to build (primary, gcds, or both)"
        type: choice
        options:
          - primary
          - gcds
          - both
        default: primary

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Free disk space
        shell: bash
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/local/.ghcup \
                      /opt/hostedtoolcache/CodeQL \
                      /usr/local/lib/android/sdk/ndk \
                      /usr/share/dotnet \
                      /opt/ghc \
                      /usr/local/share/boost
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r VALIDATION/requirements.txt

      - name: Fetch CSV & convert to JSONL
        env:
          AZURE_ACCOUNT_URL: ${{ secrets.AZURE_ACCOUNT_URL }}
          AZURE_CONTAINER: ${{ secrets.AZURE_CONTAINER }}
          AZURE_SAS_TOKEN: ${{ secrets.AZURE_SAS_TOKEN }}
          AZURE_BLOB_NAME: ${{ secrets.AZURE_BLOB_NAME }}
          OUTPUT_CSV_PATH: VALIDATION/validation.csv
          OUTPUT_JSONL_PATH: VALIDATION/validation.jsonl
        run: python VALIDATION/scripts/fetch_and_convert.py

      - name: Enrich validation JSONL
        env:
          VALIDATION_JSONL_IN: VALIDATION/validation.jsonl
          VALIDATION_JSONL_OUT: VALIDATION/validation_enriched.jsonl
          OD_JSONL_GZ_URL: https://open.canada.ca/static/od-do-canada.jsonl.gz
          OD_JSONL_GZ_PATH: od-do-canada.jsonl.gz
        run: python VALIDATION/scripts/enrich_validation.py

      - name: Build static site
        env:
          SITE_DIR: public/VALIDATION
          SITE_THEME: ${{ github.event.inputs.site-theme || 'primary' }}
          VALIDATION_JSONL: VALIDATION/validation_enriched.jsonl
        run: |
          rm -rf public
          mkdir -p "$SITE_DIR"
          python VALIDATION/scripts/build_site.py

      - name: Remove intermediate artifacts
        run: |
          rm -f VALIDATION/validation.csv \
                VALIDATION/validation.jsonl \
                VALIDATION/validation_enriched.jsonl \
                od-do-canada.jsonl.gz
          echo "Final artifact footprint:"
          du -sh public || true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
